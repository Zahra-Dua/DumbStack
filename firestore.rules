rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isParent(parentId) {
      return isAuthenticated() && request.auth.uid == parentId;
    }
    
    function isChild(childId) {
      return isAuthenticated() && request.auth.uid == childId;
    }

    match /parents/{parentId} {

      // Parent can read/write their own document
      allow read, write: if isParent(parentId);
      // Any authenticated user can read parent document (for QR code verification)
      allow read: if isAuthenticated();
      // Child can update parent's childrenIds array when linking (simplified - allow if authenticated)
      // Note: In production, add stricter validation via Cloud Function
      allow update: if isParent(parentId) || 
        (isAuthenticated() && 
         request.auth.uid in request.resource.data.childrenIds);

      match /children/{childId} {
        
        // Parent can read/write, child can read its own data
        allow read: if isParent(parentId) || isChild(childId);
        // Parent can write any child, child can only create/update its own document
        allow create: if isParent(parentId) || (isChild(childId) && request.auth.uid == childId);
        allow update: if isParent(parentId) || (isChild(childId) && request.auth.uid == childId);
        allow delete: if isParent(parentId);

        match /blockedUrls/{ruleId} {
          // Parent can read/write, child can read (to check if URL is blocked)
          allow read: if isParent(parentId) || isChild(childId);
          allow create, update, delete: if isParent(parentId);
        }

        match /visitedUrls/{urlId} {
          // Parent can read, child can only create logs
          allow read: if isParent(parentId);
          allow create: if isChild(childId);
          allow update, delete: if false;
        }

        match /blockNotifications/{notificationId} {
          allow read: if isChild(childId);
          allow write: if isParent(parentId);
        }

        match /fcmNotifications/{notificationId} {
          allow read: if isChild(childId);
          allow write: if isParent(parentId);
        }

        match /messages/{messageId} {
          // Parent and child can both read messages
          allow read: if isParent(parentId) || isChild(childId);
          // Both can create messages (for communication)
          allow create: if isParent(parentId) || isChild(childId);
          // Only parent can update/delete
          allow update, delete: if isParent(parentId);
        }

        match /location/{locationId} {
          // Parent can read, child can create/update its own location
          allow read: if isParent(parentId) || isChild(childId);
          allow create, update: if isParent(parentId) || (isChild(childId) && request.auth.uid == childId);
          allow delete: if isParent(parentId);
        }
      }
    }
  }
}
